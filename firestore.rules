rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserId() {
      return request.auth.uid;
    }

    function hasStrataAccess(strataId) {
      // Check if user has access to this strata
      return exists(/databases/$(database)/documents/userStrataAccess/$(getUserId() + '_' + strataId));
    }

    function getUserRole(strataId) {
      // Get user's role in this strata
      return get(/databases/$(database)/documents/userStrataAccess/$(getUserId() + '_' + strataId)).data.role;
    }

    function isMasterAdmin() {
      return request.auth.token.email == 'rfinnbogason@gmail.com';
    }

    function hasRole(strataId, roles) {
      return getUserRole(strataId) in roles;
    }

    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated() && (userId == getUserId() || isMasterAdmin());
      allow write: if isAuthenticated() && (userId == getUserId() || isMasterAdmin());
    }

    // Validation helpers
    function validateFinancialAmount(amount) {
      return amount != null && amount is number && amount >= 0 && amount <= 999999999;
    }

    function validateEmail(email) {
      return email != null && email is string && email.matches('.*@.*\\..*');
    }

    function validateRequired(field) {
      return field != null && field != '';
    }

    // User-Strata Access mapping
    match /userStrataAccess/{accessId} {
      allow read: if isAuthenticated() && (resource.data.userId == getUserId() || isMasterAdmin());
      allow write: if isMasterAdmin() || hasRole(resource.data.strataId, ['chairperson', 'property_manager']);
    }

    // Strata organizations
    match /strata/{strataId} {
      allow read: if isAuthenticated() && (hasStrataAccess(strataId) || isMasterAdmin());
      allow write: if isMasterAdmin() || hasRole(strataId, ['chairperson', 'property_manager']);

      // Units
      match /units/{unitId} {
        allow read: if isAuthenticated() && (hasStrataAccess(strataId) || isMasterAdmin());
        allow write: if hasRole(strataId, ['chairperson', 'treasurer', 'secretary', 'property_manager']) || isMasterAdmin();
      }

      // Expenses
      match /expenses/{expenseId} {
        allow read: if isAuthenticated() && (hasStrataAccess(strataId) || isMasterAdmin());
        allow create: if hasRole(strataId, ['chairperson', 'treasurer', 'property_manager']) || isMasterAdmin();
        allow update: if hasRole(strataId, ['chairperson', 'treasurer', 'property_manager']) || isMasterAdmin();
        allow delete: if hasRole(strataId, ['chairperson', 'treasurer']) || isMasterAdmin();
      }

      // Funds
      match /funds/{fundId} {
        allow read: if isAuthenticated() && (hasStrataAccess(strataId) || isMasterAdmin());
        allow write: if hasRole(strataId, ['chairperson', 'treasurer']) || isMasterAdmin();
      }

      // Quotes
      match /quotes/{quoteId} {
        allow read: if isAuthenticated() && (hasStrataAccess(strataId) || isMasterAdmin());
        allow create: if hasRole(strataId, ['chairperson', 'treasurer', 'secretary', 'property_manager', 'council_member']) || isMasterAdmin();
        allow update: if hasRole(strataId, ['chairperson', 'treasurer', 'property_manager']) || isMasterAdmin();
        allow delete: if hasRole(strataId, ['chairperson']) || isMasterAdmin();
      }

      // Meetings
      match /meetings/{meetingId} {
        allow read: if isAuthenticated() && (hasStrataAccess(strataId) || isMasterAdmin());
        allow create: if hasRole(strataId, ['chairperson', 'secretary', 'property_manager']) || isMasterAdmin();
        allow update: if hasRole(strataId, ['chairperson', 'secretary', 'property_manager']) || isMasterAdmin();
        allow delete: if hasRole(strataId, ['chairperson']) || isMasterAdmin();
      }

      // Documents
      match /documents/{documentId} {
        allow read: if isAuthenticated() && (hasStrataAccess(strataId) || isMasterAdmin());
        allow create: if hasRole(strataId, ['chairperson', 'secretary', 'treasurer', 'property_manager']) || isMasterAdmin();
        allow update: if hasRole(strataId, ['chairperson', 'secretary', 'property_manager']) || isMasterAdmin();
        allow delete: if hasRole(strataId, ['chairperson']) || isMasterAdmin();
      }

      // Maintenance Requests
      match /maintenanceRequests/{requestId} {
        allow read: if isAuthenticated() && (hasStrataAccess(strataId) || isMasterAdmin());
        allow create: if isAuthenticated() && (hasStrataAccess(strataId) || isMasterAdmin());
        allow update: if hasRole(strataId, ['chairperson', 'secretary', 'property_manager', 'council_member']) || isMasterAdmin() || resource.data.submittedBy == getUserId();
        allow delete: if hasRole(strataId, ['chairperson', 'property_manager']) || isMasterAdmin() || resource.data.submittedBy == getUserId();
      }

      // Announcements
      match /announcements/{announcementId} {
        allow read: if isAuthenticated() && (hasStrataAccess(strataId) || isMasterAdmin());
        allow create: if hasRole(strataId, ['chairperson', 'secretary', 'property_manager', 'council_member']) || isMasterAdmin();
        allow update: if hasRole(strataId, ['chairperson', 'secretary', 'property_manager']) || isMasterAdmin();
        allow delete: if hasRole(strataId, ['chairperson', 'secretary']) || isMasterAdmin();
      }
    }

    // Vendors (strata-isolated)
    match /vendors/{vendorId} {
      allow read: if isAuthenticated() && (hasStrataAccess(resource.data.strataId) || isMasterAdmin());
      allow create: if hasRole(request.resource.data.strataId, ['chairperson', 'property_manager', 'treasurer']) || isMasterAdmin(); // Only admins/authorized roles can create vendors
      allow update: if hasStrataAccess(resource.data.strataId) && hasRole(resource.data.strataId, ['chairperson', 'property_manager', 'treasurer']) || isMasterAdmin();
      allow delete: if hasStrataAccess(resource.data.strataId) && hasRole(resource.data.strataId, ['chairperson']) || isMasterAdmin();
    }

    // Notifications (user-specific)
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && (resource.data.userId == getUserId() || isMasterAdmin());
      allow write: if isAuthenticated() && (request.resource.data.userId == getUserId() || isMasterAdmin());
    }

    // Messages
    match /messages/{messageId} {
      allow read: if isAuthenticated() && (
        getUserId() in resource.data.recipientIds ||
        resource.data.senderId == getUserId() ||
        isMasterAdmin()
      );
      allow create: if isAuthenticated() && request.resource.data.senderId == getUserId();
      allow update: if isAuthenticated() && (
        getUserId() in resource.data.recipientIds ||
        resource.data.senderId == getUserId() ||
        isMasterAdmin()
      );
    }

    // Payment Reminders
    match /paymentReminders/{reminderId} {
      allow read: if isAuthenticated() && (hasStrataAccess(resource.data.strataId) || isMasterAdmin());
      allow write: if hasStrataAccess(request.resource.data.strataId) && hasRole(request.resource.data.strataId, ['chairperson', 'treasurer']) || isMasterAdmin();
    }

    // Pending Registrations (admin only)
    match /pendingRegistrations/{registrationId} {
      allow read: if isMasterAdmin();
      allow create: if isMasterAdmin(); // Only admins can create pending registrations
      allow update, delete: if isMasterAdmin();
    }

    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
